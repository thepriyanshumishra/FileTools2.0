class I{static read_bytes(e,t){const i=new I;return i.buf=e.getUint32(t,!0),i.buf_len=e.getUint32(t+4,!0),i}static read_bytes_array(e,t,i){const l=[];for(let n=0;n<i;n++)l.push(I.read_bytes(e,t+8*n));return l}}class x{static read_bytes(e,t){const i=new x;return i.buf=e.getUint32(t,!0),i.buf_len=e.getUint32(t+4,!0),i}static read_bytes_array(e,t,i){const l=[];for(let n=0;n<i;n++)l.push(x.read_bytes(e,t+8*n));return l}}const pe=0,ye=1,ie=2,Z=2,w=3,L=4;class P{head_length(){return 24}name_length(){return this.dir_name.byteLength}write_head_bytes(e,t){e.setBigUint64(t,this.d_next,!0),e.setBigUint64(t+8,this.d_ino,!0),e.setUint32(t+16,this.dir_name.length,!0),e.setUint8(t+20,this.d_type)}write_name_bytes(e,t,i){e.set(this.dir_name.slice(0,Math.min(this.dir_name.byteLength,i)),t)}constructor(e,t,i,l){const n=new TextEncoder().encode(i);this.d_next=e,this.d_ino=t,this.d_namlen=n.byteLength,this.d_type=l,this.dir_name=n}}const ge=1;class z{write_bytes(e,t){e.setUint8(t,this.fs_filetype),e.setUint16(t+2,this.fs_flags,!0),e.setBigUint64(t+8,this.fs_rights_base,!0),e.setBigUint64(t+16,this.fs_rights_inherited,!0)}constructor(e,t){this.fs_rights_base=0n,this.fs_rights_inherited=0n,this.fs_filetype=e,this.fs_flags=t}}const M=1,T=2,J=4,Q=8;class j{write_bytes(e,t){e.setBigUint64(t,this.dev,!0),e.setBigUint64(t+8,this.ino,!0),e.setUint8(t+16,this.filetype),e.setBigUint64(t+24,this.nlink,!0),e.setBigUint64(t+32,this.size,!0),e.setBigUint64(t+38,this.atim,!0),e.setBigUint64(t+46,this.mtim,!0),e.setBigUint64(t+52,this.ctim,!0)}constructor(e,t,i){this.dev=0n,this.nlink=0n,this.atim=0n,this.mtim=0n,this.ctim=0n,this.ino=e,this.filetype=t,this.size=i}}const Ee=0,we=1;class W{static read_bytes(e,t){return new W(e.getBigUint64(t,!0),e.getUint8(t+8),e.getUint32(t+16,!0),e.getBigUint64(t+24,!0),e.getUint16(t+36,!0))}constructor(e,t,i,l,n){this.userdata=e,this.eventtype=t,this.clockid=i,this.timeout=l,this.flags=n}}class Ne{write_bytes(e,t){e.setBigUint64(t,this.userdata,!0),e.setUint16(t+8,this.error,!0),e.setUint8(t+10,this.eventtype)}constructor(e,t,i){this.userdata=e,this.error=t,this.eventtype=i}}const me=0;class be{write_bytes(e,t){e.setUint32(t,this.pr_name.byteLength,!0)}constructor(e){this.pr_name=new TextEncoder().encode(e)}}class G{static dir(e){const t=new G;return t.tag=me,t.inner=new be(e),t}write_bytes(e,t){e.setUint32(t,this.tag,!0),this.inner.write_bytes(e,t+4)}}let Oe=class{enable(e){this.log=Ue(e===void 0?!0:e,this.prefix)}get enabled(){return this.isEnabled}constructor(e){this.isEnabled=e,this.prefix="wasi:",this.enable(e)}};function Ue(s,e){return s?console.log.bind(console,"%c%s","color: #265BA0",e):()=>{}}const g=new Oe(!1);class ee extends Error{constructor(e){super("exit with exit code "+e),this.code=e}}let Se=class{start(e){this.inst=e;try{return e.exports._start(),0}catch(t){if(t instanceof ee)return t.code;throw t}}initialize(e){this.inst=e,e.exports._initialize&&e.exports._initialize()}constructor(e,t,i,l={}){this.args=[],this.env=[],this.fds=[],g.enable(l.debug),this.args=e,this.env=t,this.fds=i;const n=this;this.wasiImport={args_sizes_get(r,o){const f=new DataView(n.inst.exports.memory.buffer);f.setUint32(r,n.args.length,!0);let a=0;for(const u of n.args)a+=u.length+1;return f.setUint32(o,a,!0),g.log(f.getUint32(r,!0),f.getUint32(o,!0)),0},args_get(r,o){const f=new DataView(n.inst.exports.memory.buffer),a=new Uint8Array(n.inst.exports.memory.buffer),u=o;for(let d=0;d<n.args.length;d++){f.setUint32(r,o,!0),r+=4;const c=new TextEncoder().encode(n.args[d]);a.set(c,o),f.setUint8(o+c.length,0),o+=c.length+1}return g.enabled&&g.log(new TextDecoder("utf-8").decode(a.slice(u,o))),0},environ_sizes_get(r,o){const f=new DataView(n.inst.exports.memory.buffer);f.setUint32(r,n.env.length,!0);let a=0;for(const u of n.env)a+=new TextEncoder().encode(u).length+1;return f.setUint32(o,a,!0),g.log(f.getUint32(r,!0),f.getUint32(o,!0)),0},environ_get(r,o){const f=new DataView(n.inst.exports.memory.buffer),a=new Uint8Array(n.inst.exports.memory.buffer),u=o;for(let d=0;d<n.env.length;d++){f.setUint32(r,o,!0),r+=4;const c=new TextEncoder().encode(n.env[d]);a.set(c,o),f.setUint8(o+c.length,0),o+=c.length+1}return g.enabled&&g.log(new TextDecoder("utf-8").decode(a.slice(u,o))),0},clock_res_get(r,o){let f;switch(r){case 1:{f=5000n;break}case 0:{f=1000000n;break}default:return 52}return new DataView(n.inst.exports.memory.buffer).setBigUint64(o,f,!0),0},clock_time_get(r,o,f){const a=new DataView(n.inst.exports.memory.buffer);if(r===0)a.setBigUint64(f,BigInt(new Date().getTime())*1000000n,!0);else if(r==1){let u;try{u=BigInt(Math.round(performance.now()*1e6))}catch{u=0n}a.setBigUint64(f,u,!0)}else a.setBigUint64(f,0n,!0);return 0},fd_advise(r,o,f,a){return n.fds[r]!=null?0:8},fd_allocate(r,o,f){return n.fds[r]!=null?n.fds[r].fd_allocate(o,f):8},fd_close(r){if(n.fds[r]!=null){const o=n.fds[r].fd_close();return n.fds[r]=void 0,o}else return 8},fd_datasync(r){return n.fds[r]!=null?n.fds[r].fd_sync():8},fd_fdstat_get(r,o){if(n.fds[r]!=null){const{ret:f,fdstat:a}=n.fds[r].fd_fdstat_get();return a?.write_bytes(new DataView(n.inst.exports.memory.buffer),o),f}else return 8},fd_fdstat_set_flags(r,o){return n.fds[r]!=null?n.fds[r].fd_fdstat_set_flags(o):8},fd_fdstat_set_rights(r,o,f){return n.fds[r]!=null?n.fds[r].fd_fdstat_set_rights(o,f):8},fd_filestat_get(r,o){if(n.fds[r]!=null){const{ret:f,filestat:a}=n.fds[r].fd_filestat_get();return a?.write_bytes(new DataView(n.inst.exports.memory.buffer),o),f}else return 8},fd_filestat_set_size(r,o){return n.fds[r]!=null?n.fds[r].fd_filestat_set_size(o):8},fd_filestat_set_times(r,o,f,a){return n.fds[r]!=null?n.fds[r].fd_filestat_set_times(o,f,a):8},fd_pread(r,o,f,a,u){const d=new DataView(n.inst.exports.memory.buffer),c=new Uint8Array(n.inst.exports.memory.buffer);if(n.fds[r]!=null){const _=I.read_bytes_array(d,o,f);let h=0;for(const R of _){const{ret:p,data:y}=n.fds[r].fd_pread(R.buf_len,a);if(p!=0)return d.setUint32(u,h,!0),p;if(c.set(y,R.buf),h+=y.length,a+=BigInt(y.length),y.length!=R.buf_len)break}return d.setUint32(u,h,!0),0}else return 8},fd_prestat_get(r,o){const f=new DataView(n.inst.exports.memory.buffer);if(n.fds[r]!=null){const{ret:a,prestat:u}=n.fds[r].fd_prestat_get();return u?.write_bytes(f,o),a}else return 8},fd_prestat_dir_name(r,o,f){if(n.fds[r]!=null){const{ret:a,prestat:u}=n.fds[r].fd_prestat_get();if(u==null)return a;const d=u.inner.pr_name;return new Uint8Array(n.inst.exports.memory.buffer).set(d.slice(0,f),o),d.byteLength>f?37:0}else return 8},fd_pwrite(r,o,f,a,u){const d=new DataView(n.inst.exports.memory.buffer),c=new Uint8Array(n.inst.exports.memory.buffer);if(n.fds[r]!=null){const _=x.read_bytes_array(d,o,f);let h=0;for(const R of _){const p=c.slice(R.buf,R.buf+R.buf_len),{ret:y,nwritten:N}=n.fds[r].fd_pwrite(p,a);if(y!=0)return d.setUint32(u,h,!0),y;if(h+=N,a+=BigInt(N),N!=p.byteLength)break}return d.setUint32(u,h,!0),0}else return 8},fd_read(r,o,f,a){const u=new DataView(n.inst.exports.memory.buffer),d=new Uint8Array(n.inst.exports.memory.buffer);if(n.fds[r]!=null){const c=I.read_bytes_array(u,o,f);let _=0;for(const h of c){const{ret:R,data:p}=n.fds[r].fd_read(h.buf_len);if(R!=0)return u.setUint32(a,_,!0),R;if(d.set(p,h.buf),_+=p.length,p.length!=h.buf_len)break}return u.setUint32(a,_,!0),0}else return 8},fd_readdir(r,o,f,a,u){const d=new DataView(n.inst.exports.memory.buffer),c=new Uint8Array(n.inst.exports.memory.buffer);if(n.fds[r]!=null){let _=0;for(;;){const{ret:h,dirent:R}=n.fds[r].fd_readdir_single(a);if(h!=0)return d.setUint32(u,_,!0),h;if(R==null)break;if(f-_<R.head_length()){_=f;break}const p=new ArrayBuffer(R.head_length());if(R.write_head_bytes(new DataView(p),0),c.set(new Uint8Array(p).slice(0,Math.min(p.byteLength,f-_)),o),o+=R.head_length(),_+=R.head_length(),f-_<R.name_length()){_=f;break}R.write_name_bytes(c,o,f-_),o+=R.name_length(),_+=R.name_length(),a=R.d_next}return d.setUint32(u,_,!0),0}else return 8},fd_renumber(r,o){if(n.fds[r]!=null&&n.fds[o]!=null){const f=n.fds[o].fd_close();return f!=0?f:(n.fds[o]=n.fds[r],n.fds[r]=void 0,0)}else return 8},fd_seek(r,o,f,a){const u=new DataView(n.inst.exports.memory.buffer);if(n.fds[r]!=null){const{ret:d,offset:c}=n.fds[r].fd_seek(o,f);return u.setBigInt64(a,c,!0),d}else return 8},fd_sync(r){return n.fds[r]!=null?n.fds[r].fd_sync():8},fd_tell(r,o){const f=new DataView(n.inst.exports.memory.buffer);if(n.fds[r]!=null){const{ret:a,offset:u}=n.fds[r].fd_tell();return f.setBigUint64(o,u,!0),a}else return 8},fd_write(r,o,f,a){const u=new DataView(n.inst.exports.memory.buffer),d=new Uint8Array(n.inst.exports.memory.buffer);if(n.fds[r]!=null){const c=x.read_bytes_array(u,o,f);let _=0;for(const h of c){const R=d.slice(h.buf,h.buf+h.buf_len),{ret:p,nwritten:y}=n.fds[r].fd_write(R);if(p!=0)return u.setUint32(a,_,!0),p;if(_+=y,y!=R.byteLength)break}return u.setUint32(a,_,!0),0}else return 8},path_create_directory(r,o,f){const a=new Uint8Array(n.inst.exports.memory.buffer);if(n.fds[r]!=null){const u=new TextDecoder("utf-8").decode(a.slice(o,o+f));return n.fds[r].path_create_directory(u)}else return 8},path_filestat_get(r,o,f,a,u){const d=new DataView(n.inst.exports.memory.buffer),c=new Uint8Array(n.inst.exports.memory.buffer);if(n.fds[r]!=null){const _=new TextDecoder("utf-8").decode(c.slice(f,f+a)),{ret:h,filestat:R}=n.fds[r].path_filestat_get(o,_);return R?.write_bytes(d,u),h}else return 8},path_filestat_set_times(r,o,f,a,u,d,c){const _=new Uint8Array(n.inst.exports.memory.buffer);if(n.fds[r]!=null){const h=new TextDecoder("utf-8").decode(_.slice(f,f+a));return n.fds[r].path_filestat_set_times(o,h,u,d,c)}else return 8},path_link(r,o,f,a,u,d,c){const _=new Uint8Array(n.inst.exports.memory.buffer);if(n.fds[r]!=null&&n.fds[u]!=null){const h=new TextDecoder("utf-8").decode(_.slice(f,f+a)),R=new TextDecoder("utf-8").decode(_.slice(d,d+c)),{ret:p,inode_obj:y}=n.fds[r].path_lookup(h,o);return y==null?p:n.fds[u].path_link(R,y,!1)}else return 8},path_open(r,o,f,a,u,d,c,_,h){const R=new DataView(n.inst.exports.memory.buffer),p=new Uint8Array(n.inst.exports.memory.buffer);if(n.fds[r]!=null){const y=new TextDecoder("utf-8").decode(p.slice(f,f+a));g.log(y);const{ret:N,fd_obj:K}=n.fds[r].path_open(o,y,u,d,c,_);if(N!=0)return N;n.fds.push(K);const $=n.fds.length-1;return R.setUint32(h,$,!0),0}else return 8},path_readlink(r,o,f,a,u,d){const c=new DataView(n.inst.exports.memory.buffer),_=new Uint8Array(n.inst.exports.memory.buffer);if(n.fds[r]!=null){const h=new TextDecoder("utf-8").decode(_.slice(o,o+f));g.log(h);const{ret:R,data:p}=n.fds[r].path_readlink(h);if(p!=null){const y=new TextEncoder().encode(p);if(y.length>u)return c.setUint32(d,0,!0),8;_.set(y,a),c.setUint32(d,y.length,!0)}return R}else return 8},path_remove_directory(r,o,f){const a=new Uint8Array(n.inst.exports.memory.buffer);if(n.fds[r]!=null){const u=new TextDecoder("utf-8").decode(a.slice(o,o+f));return n.fds[r].path_remove_directory(u)}else return 8},path_rename(r,o,f,a,u,d){const c=new Uint8Array(n.inst.exports.memory.buffer);if(n.fds[r]!=null&&n.fds[a]!=null){const _=new TextDecoder("utf-8").decode(c.slice(o,o+f)),h=new TextDecoder("utf-8").decode(c.slice(u,u+d));let{ret:R,inode_obj:p}=n.fds[r].path_unlink(_);if(p==null)return R;if(R=n.fds[a].path_link(h,p,!0),R!=0&&n.fds[r].path_link(_,p,!0)!=0)throw"path_link should always return success when relinking an inode back to the original place";return R}else return 8},path_symlink(r,o,f,a,u){const d=new Uint8Array(n.inst.exports.memory.buffer);return n.fds[f]!=null?(new TextDecoder("utf-8").decode(d.slice(r,r+o)),new TextDecoder("utf-8").decode(d.slice(a,a+u)),58):8},path_unlink_file(r,o,f){const a=new Uint8Array(n.inst.exports.memory.buffer);if(n.fds[r]!=null){const u=new TextDecoder("utf-8").decode(a.slice(o,o+f));return n.fds[r].path_unlink_file(u)}else return 8},poll_oneoff(r,o,f){if(f===0)return 28;if(f>1)return g.log("poll_oneoff: only a single subscription is supported"),58;const a=new DataView(n.inst.exports.memory.buffer),u=W.read_bytes(a,r),d=u.eventtype,c=u.clockid,_=u.timeout;if(d!==Ee)return g.log("poll_oneoff: only clock subscriptions are supported"),58;let h;if(c===1)h=()=>BigInt(Math.round(performance.now()*1e6));else if(c===0)h=()=>BigInt(new Date().getTime())*1000000n;else return 28;const R=u.flags&we?_:h()+_;for(;R>h(););return new Ne(u.userdata,0,d).write_bytes(a,o),0},proc_exit(r){throw new ee(r)},proc_raise(r){throw"raised signal "+r},sched_yield(){},random_get(r,o){const f=new Uint8Array(n.inst.exports.memory.buffer).subarray(r,r+o);if("crypto"in globalThis&&(typeof SharedArrayBuffer>"u"||!(n.inst.exports.memory.buffer instanceof SharedArrayBuffer)))for(let a=0;a<o;a+=65536)crypto.getRandomValues(f.subarray(a,a+65536));else for(let a=0;a<o;a++)f[a]=Math.random()*256|0},sock_recv(r,o,f){throw"sockets not supported"},sock_send(r,o,f){throw"sockets not supported"},sock_shutdown(r,o){throw"sockets not supported"},sock_accept(r,o){throw"sockets not supported"}}}};class Y{fd_allocate(e,t){return 58}fd_close(){return 0}fd_fdstat_get(){return{ret:58,fdstat:null}}fd_fdstat_set_flags(e){return 58}fd_fdstat_set_rights(e,t){return 58}fd_filestat_get(){return{ret:58,filestat:null}}fd_filestat_set_size(e){return 58}fd_filestat_set_times(e,t,i){return 58}fd_pread(e,t){return{ret:58,data:new Uint8Array}}fd_prestat_get(){return{ret:58,prestat:null}}fd_pwrite(e,t){return{ret:58,nwritten:0}}fd_read(e){return{ret:58,data:new Uint8Array}}fd_readdir_single(e){return{ret:58,dirent:null}}fd_seek(e,t){return{ret:58,offset:0n}}fd_sync(){return 0}fd_tell(){return{ret:58,offset:0n}}fd_write(e){return{ret:58,nwritten:0}}path_create_directory(e){return 58}path_filestat_get(e,t){return{ret:58,filestat:null}}path_filestat_set_times(e,t,i,l,n){return 58}path_link(e,t,i){return 58}path_unlink(e){return{ret:58,inode_obj:null}}path_lookup(e,t){return{ret:58,inode_obj:null}}path_open(e,t,i,l,n,r){return{ret:54,fd_obj:null}}path_readlink(e){return{ret:58,data:null}}path_remove_directory(e){return 58}path_rename(e,t,i){return 58}path_unlink_file(e){return 58}}class U{static issue_ino(){return U.next_ino++}static root_ino(){return 0n}constructor(){this.ino=U.issue_ino()}}U.next_ino=1n;class oe extends Y{fd_allocate(e,t){if(!(this.file.size>e+t)){const i=new Uint8Array(Number(e+t));i.set(this.file.data,0),this.file.data=i}return 0}fd_fdstat_get(){return{ret:0,fdstat:new z(L,0)}}fd_filestat_set_size(e){if(this.file.size>e)this.file.data=new Uint8Array(this.file.data.buffer.slice(0,Number(e)));else{const t=new Uint8Array(Number(e));t.set(this.file.data,0),this.file.data=t}return 0}fd_read(e){const t=this.file.data.slice(Number(this.file_pos),Number(this.file_pos+BigInt(e)));return this.file_pos+=BigInt(t.length),{ret:0,data:t}}fd_pread(e,t){return{ret:0,data:this.file.data.slice(Number(t),Number(t+BigInt(e)))}}fd_seek(e,t){let i;switch(t){case pe:i=e;break;case ye:i=this.file_pos+e;break;case ie:i=BigInt(this.file.data.byteLength)+e;break;default:return{ret:28,offset:0n}}return i<0?{ret:28,offset:0n}:(this.file_pos=i,{ret:0,offset:this.file_pos})}fd_tell(){return{ret:0,offset:this.file_pos}}fd_write(e){if(this.file.readonly)return{ret:8,nwritten:0};if(this.file_pos+BigInt(e.byteLength)>this.file.size){const t=this.file.data;this.file.data=new Uint8Array(Number(this.file_pos+BigInt(e.byteLength))),this.file.data.set(t)}return this.file.data.set(e,Number(this.file_pos)),this.file_pos+=BigInt(e.byteLength),{ret:0,nwritten:e.byteLength}}fd_pwrite(e,t){if(this.file.readonly)return{ret:8,nwritten:0};if(t+BigInt(e.byteLength)>this.file.size){const i=this.file.data;this.file.data=new Uint8Array(Number(t+BigInt(e.byteLength))),this.file.data.set(i)}return this.file.data.set(e,Number(t)),{ret:0,nwritten:e.byteLength}}fd_filestat_get(){return{ret:0,filestat:this.file.stat()}}constructor(e){super(),this.file_pos=0n,this.file=e}}class fe extends Y{fd_seek(e,t){return{ret:8,offset:0n}}fd_tell(){return{ret:8,offset:0n}}fd_allocate(e,t){return 8}fd_fdstat_get(){return{ret:0,fdstat:new z(w,0)}}fd_readdir_single(e){if(g.enabled&&(g.log("readdir_single",e),g.log(e,this.dir.contents.keys())),e==0n)return{ret:0,dirent:new P(1n,this.dir.ino,".",w)};if(e==1n)return{ret:0,dirent:new P(2n,this.dir.parent_ino(),"..",w)};if(e>=BigInt(this.dir.contents.size)+2n)return{ret:0,dirent:null};const[t,i]=Array.from(this.dir.contents.entries())[Number(e-2n)];return{ret:0,dirent:new P(e+1n,i.ino,t,i.stat().filetype)}}path_filestat_get(e,t){const{ret:i,path:l}=b.from(t);if(l==null)return{ret:i,filestat:null};const{ret:n,entry:r}=this.dir.get_entry_for_path(l);return r==null?{ret:n,filestat:null}:{ret:0,filestat:r.stat()}}path_lookup(e,t){const{ret:i,path:l}=b.from(e);if(l==null)return{ret:i,inode_obj:null};const{ret:n,entry:r}=this.dir.get_entry_for_path(l);return r==null?{ret:n,inode_obj:null}:{ret:0,inode_obj:r}}path_open(e,t,i,l,n,r){const{ret:o,path:f}=b.from(t);if(f==null)return{ret:o,fd_obj:null};let{ret:a,entry:u}=this.dir.get_entry_for_path(f);if(u==null){if(a!=44)return{ret:a,fd_obj:null};if((i&M)==M){const{ret:d,entry:c}=this.dir.create_entry_for_path(t,(i&T)==T);if(c==null)return{ret:d,fd_obj:null};u=c}else return{ret:44,fd_obj:null}}else if((i&J)==J)return{ret:20,fd_obj:null};return(i&T)==T&&u.stat().filetype!==w?{ret:54,fd_obj:null}:u.path_open(i,l,r)}path_create_directory(e){return this.path_open(0,e,M|T,0n,0n,0).ret}path_link(e,t,i){const{ret:l,path:n}=b.from(e);if(n==null)return l;if(n.is_dir)return 44;const{ret:r,parent_entry:o,filename:f,entry:a}=this.dir.get_parent_dir_and_entry_for_path(n,!0);if(o==null||f==null)return r;if(a!=null){const u=t.stat().filetype==w,d=a.stat().filetype==w;if(u&&d)if(i&&a instanceof O){if(a.contents.size!=0)return 55}else return 20;else{if(u&&!d)return 54;if(!u&&d)return 31;if(!(t.stat().filetype==L&&a.stat().filetype==L))return 20}}return!i&&t.stat().filetype==w?63:(o.contents.set(f,t),0)}path_unlink(e){const{ret:t,path:i}=b.from(e);if(i==null)return{ret:t,inode_obj:null};const{ret:l,parent_entry:n,filename:r,entry:o}=this.dir.get_parent_dir_and_entry_for_path(i,!0);return n==null||r==null?{ret:l,inode_obj:null}:o==null?{ret:44,inode_obj:null}:(n.contents.delete(r),{ret:0,inode_obj:o})}path_unlink_file(e){const{ret:t,path:i}=b.from(e);if(i==null)return t;const{ret:l,parent_entry:n,filename:r,entry:o}=this.dir.get_parent_dir_and_entry_for_path(i,!1);return n==null||r==null||o==null?l:o.stat().filetype===w?31:(n.contents.delete(r),0)}path_remove_directory(e){const{ret:t,path:i}=b.from(e);if(i==null)return t;const{ret:l,parent_entry:n,filename:r,entry:o}=this.dir.get_parent_dir_and_entry_for_path(i,!1);return n==null||r==null||o==null?l:!(o instanceof O)||o.stat().filetype!==w?54:o.contents.size!==0?55:n.contents.delete(r)?0:44}fd_filestat_get(){return{ret:0,filestat:this.dir.stat()}}fd_filestat_set_size(e){return 8}fd_read(e){return{ret:8,data:new Uint8Array}}fd_pread(e,t){return{ret:8,data:new Uint8Array}}fd_write(e){return{ret:8,nwritten:0}}fd_pwrite(e,t){return{ret:8,nwritten:0}}constructor(e){super(),this.dir=e}}class te extends fe{fd_prestat_get(){return{ret:0,prestat:G.dir(this.prestat_name)}}constructor(e,t){super(new O(t)),this.prestat_name=e}}let D=class extends U{path_open(e,t,i){if(this.readonly&&(t&BigInt(64))==BigInt(64))return{ret:63,fd_obj:null};if((e&Q)==Q){if(this.readonly)return{ret:63,fd_obj:null};this.data=new Uint8Array([])}const l=new oe(this);return i&ge&&l.fd_seek(0n,ie),{ret:0,fd_obj:l}}get size(){return BigInt(this.data.byteLength)}stat(){return new j(this.ino,L,this.size)}constructor(e,t){super(),this.data=new Uint8Array(e),this.readonly=!!t?.readonly}},b=class ae{static from(e){const t=new ae;if(t.is_dir=e.endsWith("/"),e.startsWith("/"))return{ret:76,path:null};if(e.includes("\0"))return{ret:28,path:null};for(const i of e.split("/"))if(!(i===""||i===".")){if(i===".."){if(t.parts.pop()==null)return{ret:76,path:null};continue}t.parts.push(i)}return{ret:0,path:t}}to_path_string(){let e=this.parts.join("/");return this.is_dir&&(e+="/"),e}constructor(){this.parts=[],this.is_dir=!1}};class O extends U{parent_ino(){return this.parent==null?U.root_ino():this.parent.ino}path_open(e,t,i){return{ret:0,fd_obj:new fe(this)}}stat(){return new j(this.ino,w,0n)}get_entry_for_path(e){let t=this;for(const i of e.parts){if(!(t instanceof O))return{ret:54,entry:null};const l=t.contents.get(i);if(l!==void 0)t=l;else return g.log(i),{ret:44,entry:null}}return e.is_dir&&t.stat().filetype!=w?{ret:54,entry:null}:{ret:0,entry:t}}get_parent_dir_and_entry_for_path(e,t){const i=e.parts.pop();if(i===void 0)return{ret:28,parent_entry:null,filename:null,entry:null};const{ret:l,entry:n}=this.get_entry_for_path(e);if(n==null)return{ret:l,parent_entry:null,filename:null,entry:null};if(!(n instanceof O))return{ret:54,parent_entry:null,filename:null,entry:null};const r=n.contents.get(i);return r===void 0?t?{ret:0,parent_entry:n,filename:i,entry:null}:{ret:44,parent_entry:null,filename:null,entry:null}:e.is_dir&&r.stat().filetype!=w?{ret:54,parent_entry:null,filename:null,entry:null}:{ret:0,parent_entry:n,filename:i,entry:r}}create_entry_for_path(e,t){const{ret:i,path:l}=b.from(e);if(l==null)return{ret:i,entry:null};let{ret:n,parent_entry:r,filename:o,entry:f}=this.get_parent_dir_and_entry_for_path(l,!0);if(r==null||o==null)return{ret:n,entry:null};if(f!=null)return{ret:20,entry:null};g.log("create",l);let a;return t?a=new O(new Map):a=new D(new ArrayBuffer(0)),r.contents.set(o,a),f=a,{ret:0,entry:f}}constructor(e){super(),this.parent=null,e instanceof Array?this.contents=new Map(e):this.contents=e;for(const t of this.contents.values())t instanceof O&&(t.parent=this)}}class k extends Y{fd_filestat_get(){return{ret:0,filestat:new j(this.ino,Z,BigInt(0))}}fd_fdstat_get(){const e=new z(Z,0);return e.fs_rights_base=BigInt(64),{ret:0,fdstat:e}}fd_write(e){return this.write(e),{ret:0,nwritten:e.byteLength}}static lineBuffered(e){const t=new TextDecoder("utf-8",{fatal:!1});let i="";return new k(l=>{i+=t.decode(l,{stream:!0});const n=i.split(`
`);for(const[r,o]of n.entries())r<n.length-1?e(o):i=o})}constructor(e){super(),this.ino=U.issue_ino(),this.write=e}}"stream"in Blob.prototype||Object.defineProperty(Blob.prototype,"stream",{value(){return new Response(this).body}}),"setBigUint64"in DataView.prototype||Object.defineProperty(DataView.prototype,"setBigUint64",{value(s,e,t){const i=Number(0xffffffffn&e),l=Number(e>>32n);this.setUint32(s+(t?0:4),i,t),this.setUint32(s+(t?4:0),l,t)}});var B=s=>new DataView(new ArrayBuffer(s)),m=s=>new Uint8Array(s.buffer||s),A=s=>new TextEncoder().encode(String(s)),S=s=>Math.min(4294967295,Number(s)),ne=s=>Math.min(65535,Number(s));function Ae(s,e,t){e===void 0||e instanceof Date||(e=new Date(e));const i=s!==void 0;if(t||(t=i?436:509),s instanceof File)return{isFile:i,t:e||new Date(s.lastModified),bytes:s.stream(),mode:t};if(s instanceof Response)return{isFile:i,t:e||new Date(s.headers.get("Last-Modified")||Date.now()),bytes:s.body,mode:t};if(e===void 0)e=new Date;else if(isNaN(e))throw new Error("Invalid modification date.");if(!i)return{isFile:i,t:e,mode:t};if(typeof s=="string")return{isFile:i,t:e,bytes:A(s),mode:t};if(s instanceof Blob)return{isFile:i,t:e,bytes:s.stream(),mode:t};if(s instanceof Uint8Array||s instanceof ReadableStream)return{isFile:i,t:e,bytes:s,mode:t};if(s instanceof ArrayBuffer||ArrayBuffer.isView(s))return{isFile:i,t:e,bytes:m(s),mode:t};if(Symbol.asyncIterator in s)return{isFile:i,t:e,bytes:le(s[Symbol.asyncIterator]()),mode:t};throw new TypeError("Unsupported input format.")}function le(s,e=s){return new ReadableStream({async pull(t){let i=0;for(;t.desiredSize>i;){const l=await s.next();if(!l.value){t.close();break}{const n=Be(l.value);t.enqueue(n),i+=n.byteLength}}},cancel(t){e.throw?.(t)}})}function Be(s){return typeof s=="string"?A(s):s instanceof Uint8Array?s:m(s)}function Te(s,e,t){let[i,l]=function(n){return n?n instanceof Uint8Array?[n,1]:ArrayBuffer.isView(n)||n instanceof ArrayBuffer?[m(n),1]:[A(n),0]:[void 0,0]}(e);if(s instanceof File)return{i:v(i||A(s.name)),o:BigInt(s.size),u:l};if(s instanceof Response){const n=s.headers.get("content-disposition"),r=n&&n.match(/;\s*filename\*?\s*=\s*(?:UTF-\d+''|)["']?([^;"'\r\n]*)["']?(?:;|$)/i),o=r&&r[1]||s.url&&new URL(s.url).pathname.split("/").findLast(Boolean),f=o&&decodeURIComponent(o),a=t||+s.headers.get("content-length");return{i:v(i||A(f)),o:BigInt(a),u:l}}return i=v(i,s!==void 0||t!==void 0),typeof s=="string"?{i,o:BigInt(A(s).length),u:l}:s instanceof Blob?{i,o:BigInt(s.size),u:l}:s instanceof ArrayBuffer||ArrayBuffer.isView(s)?{i,o:BigInt(s.byteLength),u:l}:{i,o:De(s,t),u:l}}function De(s,e){return e>-1?BigInt(e):s?void 0:0n}function v(s,e=1){if(!s||s.every(t=>t===47))throw new Error("The file must have a name.");if(e)for(;s[s.length-1]===47;)s=s.subarray(0,-1);else s[s.length-1]!==47&&(s=new Uint8Array([...s,47]));return s}var ue=new Uint32Array(256);for(let s=0;s<256;++s){let e=s;for(let t=0;t<8;++t)e=e>>>1^(1&e&&3988292384);ue[s]=e}function re(s,e=0){e=~e;for(var t=0,i=s.length;t<i;t++)e=e>>>8^ue[255&e^s[t]];return~e>>>0}function de(s,e,t=0){const i=s.getSeconds()>>1|s.getMinutes()<<5|s.getHours()<<11,l=s.getDate()|s.getMonth()+1<<5|s.getFullYear()-1980<<9;e.setUint16(t,i,1),e.setUint16(t+2,l,1)}function Ie({i:s,u:e},t){return 8*(!e||(t??function(i){try{xe.decode(i)}catch{return 0}return 1}(s)))}var xe=new TextDecoder("utf8",{fatal:1});function Ce(s,e=0){const t=B(30);return t.setUint32(0,1347093252),t.setUint32(4,754976768|e),de(s.t,t,10),t.setUint16(26,s.i.length,1),m(t)}async function*Fe(s){let{bytes:e}=s;if("then"in e&&(e=await e),e instanceof Uint8Array)yield e,s.l=re(e,0),s.o=BigInt(e.length);else{s.o=0n;const t=e.getReader();for(;;){const{value:i,done:l}=await t.read();if(l)break;s.l=re(i,s.l),s.o+=BigInt(i.length),yield i}}}function Le(s,e){const t=B(16+(e?8:0));return t.setUint32(0,1347094280),t.setUint32(4,s.isFile?s.l:0,1),e?(t.setBigUint64(8,s.o,1),t.setBigUint64(16,s.o,1)):(t.setUint32(8,S(s.o),1),t.setUint32(12,S(s.o),1)),m(t)}function ke(s,e,t=0,i=0){const l=B(46);return l.setUint32(0,1347092738),l.setUint32(4,755182848),l.setUint16(8,2048|t),de(s.t,l,12),l.setUint32(16,s.isFile?s.l:0,1),l.setUint32(20,S(s.o),1),l.setUint32(24,S(s.o),1),l.setUint16(28,s.i.length,1),l.setUint16(30,i,1),l.setUint16(40,s.mode|(s.isFile?32768:16384),1),l.setUint32(42,S(e),1),m(l)}function Pe(s,e,t){const i=B(t);return i.setUint16(0,1,1),i.setUint16(2,t-4,1),16&t&&(i.setBigUint64(4,s.o,1),i.setBigUint64(12,s.o,1)),i.setBigUint64(t-8,e,1),m(i)}function Me(s){return s instanceof File||s instanceof Response?[[s],[s]]:[[s.input,s.name,s.size],[s.input,s.lastModified,s.mode]]}function ve(s,e={}){const t=function(i){const l=i[Symbol.iterator in i?Symbol.iterator:Symbol.asyncIterator]();return{async next(){const n=await l.next();if(n.done)return n;const[r,o]=Me(n.value);return{done:0,value:Object.assign(Ae(...o),Te(...r))}},throw:l.throw?.bind(l),[Symbol.asyncIterator](){return this}}}(s);return le(async function*(i,l){const n=[];let r=0n,o=0n,f=0;for await(const d of i){const c=Ie(d,l.buffersAreUTF8);yield Ce(d,c),yield new Uint8Array(d.i),d.isFile&&(yield*Fe(d));const _=d.o>=0xffffffffn,h=12*(r>=0xffffffffn)|28*_;yield Le(d,_),n.push(ke(d,r,c,h)),n.push(d.i),h&&n.push(Pe(d,r,h)),_&&(r+=8n),o++,r+=BigInt(46+d.i.length)+d.o,f||(f=_)}let a=0n;for(const d of n)yield d,a+=BigInt(d.length);if(f||r>=0xffffffffn){const d=B(76);d.setUint32(0,1347094022),d.setBigUint64(4,BigInt(44),1),d.setUint32(12,755182848),d.setBigUint64(24,o,1),d.setBigUint64(32,o,1),d.setBigUint64(40,a,1),d.setBigUint64(48,r,1),d.setUint32(56,1347094023),d.setBigUint64(64,r+a,1),d.setUint32(72,1,1),yield m(d)}const u=B(22);u.setUint32(0,1347093766),u.setUint16(8,ne(o),1),u.setUint16(10,ne(o),1),u.setUint32(12,S(a),1),u.setUint32(16,S(r),1),yield m(u)}(t,e),t)}self.onmessage=async s=>{const e=s.data;try{const t=await Ve(e);if(!t)return;self.postMessage({...t,id:e.id})}catch(t){self.postMessage({type:"error",error:t,id:e.id})}};let V=null;const Ve=async s=>{switch(s.type){case"load":{V=s.wasm,postMessage({type:"loaded",id:"0"});break}case"convert":try{const{to:e,input:t}=s,i=t.file,l=e;if(l===".rtf")throw new Error("Converting into RTF is currently not supported.");const n=new Uint8Array(await i.arrayBuffer()),r=`-f ${se(`.${i.name.split(".").pop()||""}`)} -t ${se(l)} --extract-media=.`,[o,f,a]=await ze(r,n,i.name,l);return o.length===0?{type:"error",error:f.replaceAll("\\n",`
`).replaceAll('\\"','"').split('"').slice(1,-1).join('"'),errorKind:f.split(" ")[0]}:{type:"finished",output:o,isZip:a}}catch(e){return console.error(e),{type:"error",error:e}}}},se=s=>{switch(s){case".md":case".markdown":return"markdown";case".doc":case".docx":return"docx";case".csv":return"csv";case".tsv":return"tsv";case".docbook":return"docbook";case".epub":return"epub";case".html":return"html";case".json":return"json";case".odt":return"odt";case".rtf":return"rtf";case".rst":return"rst"}throw new Error(`Unsupported format: ${s}`)};async function ze(s,e,t,i){if(!V)throw new Error("WASM not loaded");let l="";const n=["pandoc.wasm","+RTS","-H64m","-RTS"],r=[],o=new D(e,{readonly:!0}),f=new D(new Uint8Array,{readonly:!1}),a=new Map([["in",o],["out",f]]),u=new te("/",a),d=[new oe(new D(new Uint8Array,{readonly:!0})),k.lineBuffered(E=>{console.log(`[WASI stdout] ${E}`)}),k.lineBuffered(E=>{console.warn(`[WASI stderr] ${E}`),l+=E+`
`}),u,new te("/tmp",new Map)],c=new Se(n,r,d,{debug:!1}),{instance:_}=await WebAssembly.instantiate(V,{wasi_snapshot_preview1:c.wasiImport});c.initialize(_),_.exports.__wasm_call_ctors();function h(){return new DataView(_.exports.memory.buffer)}const R=_.exports.malloc(4);h().setUint32(R,n.length,!0);const p=_.exports.malloc(4*(n.length+1));for(let E=0;E<n.length;++E){const C=_.exports.malloc(n[E].length+1);new TextEncoder().encodeInto(n[E],new Uint8Array(_.exports.memory.buffer,C,n[E].length)),h().setUint8(C+n[E].length,0),h().setUint32(p+4*E,C,!0)}h().setUint32(p+4*n.length,0,!0);const y=_.exports.malloc(4);h().setUint32(y,p,!0),_.exports.hs_init_with_rtsopts(R,y);const N=_.exports.malloc(s.length);new TextEncoder().encodeInto(s,new Uint8Array(_.exports.memory.buffer,N,s.length)),_.exports.wasm_main(N,s.length);const H=u.dir.path_open(0,BigInt(0),0).fd_obj.path_lookup(".",0).inode_obj;if(H){const E=H.path_open(0,BigInt(0),0).fd_obj;if(!E)return[f.data,l,!1];const X=[...We(E).entries()].filter(F=>F[0]!=="in"&&F[0]!=="out");if(X.length>0){const F=new File([new Uint8Array(Array.from(f.data))],`${t.split(".").slice(0,-1).join(".")}${i}`),q=new Map;for(const[he,Re]of X)q.set(he,Re);return[await je(F,q),l,!0]}}return[f.data,l,!1]}const je=async(s,e)=>{const t=_e(e),l=ve([...t,s]).getReader(),n=[];let r=!1;for(;!r;){const{done:u,value:d}=await l.read();r=u,d&&n.push(d)}const o=n.reduce((u,d)=>u+d.length,0),f=new Uint8Array(o);let a=0;for(const u of n)f.set(u,a),a+=u.length;return f},_e=(s,e="")=>{const t=[];for(const[i,l]of s){const n=e?`${e}/${i}`:i;if(l.type==="folder"){const r=_e(l.entries,n);t.push(...r)}else{const r=new File([new Uint8Array(Array.from(l.data))],n);t.push(r)}}return t},We=s=>{const e=new Map;if(!s.fd_filestat_get().filestat)return e;const i=s.path_lookup(".",0).inode_obj;if(!i)return e;const l=i.contents,n=ce(l);for(const[r,o]of n)e.set(r,o);return e},ce=s=>{const e=new Map;for(const[t,i]of s)if(i instanceof D){const l={data:i.data,type:"file"};e.set(t,l)}else{const l={entries:ce(i.contents),type:"folder"};e.set(t,l)}return e};
